"""
–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–∑–Ω–∏—Ü—ã –º–µ–∂–¥—É –∫–æ–¥–æ–º –î–û –∏ –ü–û–°–õ–ï Code Review
"""

print("=" * 70)
print("–î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø: –ö–æ–¥ –î–û vs –ü–û–°–õ–ï Code Review")
print("=" * 70)

# ========================================
# 1. –ö–û–î –î–û –†–ï–í–¨–Æ
# ========================================
print("\nüî¥ 1. –ö–û–î –î–û –†–ï–í–¨–Æ (90 —Å—Ç—Ä–æ–∫, 7 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º)")
print("-" * 70)

import sys
import os

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ before-review
before_path = os.path.join(os.path.dirname(__file__), 'src', 'before-review')
sys.path.insert(0, before_path)

import task_manager as tm_old

print("\nüìå –ü—Ä–∏–º–µ—Ä 1: SQL-–∏–Ω—ä–µ–∫—Ü–∏—è (–£–Ø–ó–í–ò–ú–û–°–¢–¨!)")
try:
    tm_old.create_db()
    # –ü–æ–ø—ã—Ç–∫–∞ SQL-–∏–Ω—ä–µ–∫—Ü–∏–∏
    malicious_input = "Test'; DROP TABLE tasks; --"
    tm_old.add_task(malicious_input, "Evil description", "pending")
    print(f"   ‚úó –û–ø–∞—Å–Ω—ã–π –≤–≤–æ–¥ –ø—Ä–∏–Ω—è—Ç –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏: {malicious_input}")
    print("   ‚úó –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∑–∞—â–∏—Ç–∞ –æ—Ç SQL-–∏–Ω—ä–µ–∫—Ü–∏–π!")
except Exception as e:
    print(f"   –û—à–∏–±–∫–∞: {e}")

print("\nüìå –ü—Ä–∏–º–µ—Ä 2: –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏")
try:
    # –ü—É—Å—Ç–æ–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
    tm_old.add_task("", "", "invalid")
    print("   ‚úó –ü—É—Å—Ç–æ–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø—Ä–∏–Ω—è—Ç!")
    print("   ‚úó –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å –ø—Ä–∏–Ω—è—Ç!")
except Exception as e:
    print(f"   –û—à–∏–±–∫–∞ (–Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞!): {e}")

print("\nüìå –ü—Ä–∏–º–µ—Ä 3: –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫")
print("   ‚úó –ü—Ä–∏ –æ—à–∏–±–∫–µ –ë–î - –ø—Ä–æ–≥—Ä–∞–º–º–∞ –ø—Ä–æ—Å—Ç–æ —É–ø–∞–¥—ë—Ç")
print("   ‚úó –ù–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π")

tasks = tm_old.get_all()
print(f"\n   –í—Å–µ–≥–æ –∑–∞–¥–∞—á –≤ –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ–π –ë–î: {len(tasks)}")

# ========================================
# 2. –ö–û–î –ü–û–°–õ–ï –†–ï–í–¨–Æ
# ========================================
print("\n\n‚úÖ 2. –ö–û–î –ü–û–°–õ–ï –†–ï–í–¨–Æ (430 —Å—Ç—Ä–æ–∫, 0 –ø—Ä–æ–±–ª–µ–º)")
print("-" * 70)

# –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –ø—É—Ç—å –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π
sys.path.remove(before_path)

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ after-review
after_path = os.path.join(os.path.dirname(__file__), 'src', 'after-review')
sys.path.insert(0, after_path)

# –£–¥–∞–ª—è–µ–º –∑–∞–∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–æ–¥—É–ª—å
if 'task_manager' in sys.modules:
    del sys.modules['task_manager']

# –¢–µ–ø–µ—Ä—å –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∏–∑ after-review
from task_manager import TaskManager, TaskStatus, ValidationError

print("\nüìå –ü—Ä–∏–º–µ—Ä 1: –ó–∞—â–∏—Ç–∞ –æ—Ç SQL-–∏–Ω—ä–µ–∫—Ü–∏–π")
try:
    manager = TaskManager("demo_safe.db")
    malicious_input = "Test'; DROP TABLE tasks; --"
    task_id = manager.add_task(malicious_input, "–≠—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ")
    print(f"   ‚úì –û–ø–∞—Å–Ω—ã–π –≤–≤–æ–¥ –æ–±—Ä–∞–±–æ—Ç–∞–Ω –±–µ–∑–æ–ø–∞—Å–Ω–æ (ID: {task_id})")
    print("   ‚úì –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã!")
    
    # –ü—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ –Ω–µ —É–¥–∞–ª–µ–Ω–∞
    all_tasks = manager.get_all_tasks()
    print(f"   ‚úì –¢–∞–±–ª–∏—Ü–∞ —Ü–µ–ª–∞, –∑–∞–¥–∞—á: {len(all_tasks)}")
except Exception as e:
    print(f"   –û—à–∏–±–∫–∞: {e}")

print("\nüìå –ü—Ä–∏–º–µ—Ä 2: –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö")
try:
    # –ü—É—Å—Ç–æ–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
    manager.add_task("", "–û–ø–∏—Å–∞–Ω–∏–µ")
    print("   ‚úó –ù–ï –î–û–õ–ñ–ù–û –ë–´–¢–¨ - –ø—É—Å—Ç–æ–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø—Ä–∏–Ω—è—Ç")
except ValidationError as e:
    print(f"   ‚úì –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ä–∞–±–æ—Ç–∞–ª–∞: {e}")

try:
    # –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å
    manager.add_task("–ó–∞–¥–∞—á–∞", "–û–ø–∏—Å–∞–Ω–∏–µ", "invalid_status")
    print("   ‚úó –ù–ï –î–û–õ–ñ–ù–û –ë–´–¢–¨ - –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å –ø—Ä–∏–Ω—è—Ç")
except ValidationError as e:
    print(f"   ‚úì –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ç–∞—Ç—É—Å–∞: {e}")

try:
    # –°–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
    manager.add_task("X" * 201, "–û–ø–∏—Å–∞–Ω–∏–µ")
    print("   ‚úó –ù–ï –î–û–õ–ñ–ù–û –ë–´–¢–¨ - –¥–ª–∏–Ω–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø—Ä–∏–Ω—è—Ç")
except ValidationError as e:
    print(f"   ‚úì –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª–∏–Ω—ã: {e}")

print("\nüìå –ü—Ä–∏–º–µ—Ä 3: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ")
print("   ‚úì Try-except –±–ª–æ–∫–∏ –≤–æ –≤—Å–µ—Ö –º–µ—Ç–æ–¥–∞—Ö")
print("   ‚úì –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏")
print("   ‚úì Custom exceptions (ValidationError, DatabaseError)")

# ========================================
# 3. –°–†–ê–í–ù–ï–ù–ò–ï –ú–ï–¢–†–ò–ö
# ========================================
print("\n\nüìä 3. –°–†–ê–í–ù–ï–ù–ò–ï –ú–ï–¢–†–ò–ö")
print("-" * 70)

metrics = [
    ("SQL-–∏–Ω—ä–µ–∫—Ü–∏–∏", "7 –º–µ—Å—Ç", "0", "‚úì –£—Å—Ç—Ä–∞–Ω–µ–Ω–æ"),
    ("–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫", "0%", "100%", "‚úì –í–µ–∑–¥–µ"),
    ("–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö", "–ù–µ—Ç", "–ï—Å—Ç—å", "‚úì –ü–æ–ª–Ω–∞—è"),
    ("–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è", "0 docstrings", "13 docstrings", "‚úì 100%"),
    ("–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ", "–ù–µ—Ç", "–ï—Å—Ç—å", "‚úì –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏"),
    ("–¢–µ—Å—Ç—ã", "0", "18", "‚úì Coverage 95%"),
    ("–ò–º–µ–Ω–æ–≤–∞–Ω–∏–µ", "c, r, t, d", "cursor, tasks", "‚úì –ß–∏—Ç–∞–µ–º–æ"),
    ("–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞", "–§—É–Ω–∫—Ü–∏–∏", "–û–û–ü –∫–ª–∞—Å—Å", "‚úì SOLID"),
]

print(f"\n{'–ü–∞—Ä–∞–º–µ—Ç—Ä':<20} {'–î–æ —Ä–µ–≤—å—é':<15} {'–ü–æ—Å–ª–µ —Ä–µ–≤—å—é':<15} {'–°—Ç–∞—Ç—É—Å'}")
print("-" * 70)
for param, before, after, status in metrics:
    print(f"{param:<20} {before:<15} {after:<15} {status}")

# ========================================
# 4. –ò–¢–û–ì–ò
# ========================================
print("\n\n" + "=" * 70)
print("‚úÖ –ò–¢–û–ì–ò CODE REVIEW")
print("=" * 70)
print("""
–ù–∞–π–¥–µ–Ω–æ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: 11 –ø—Ä–æ–±–ª–µ–º
  üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ: 3 (SQL-–∏–Ω—ä–µ–∫—Ü–∏–∏, –Ω–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫, –Ω–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏)
  üü° –í—ã—Å–æ–∫–∏–µ: 2 (–¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞, –Ω–∞—Ä—É—à–µ–Ω–∏–µ SRP)
  üü† –°—Ä–µ–¥–Ω–∏–µ: 3 (–ø–ª–æ—Ö–æ–µ –∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ, magic strings, –ø—Ä–æ—Ü–µ–¥—É—Ä–Ω—ã–π —Å—Ç–∏–ª—å)
  üü¢ –ù–∏–∑–∫–∏–µ: 3 (–Ω–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è, —Ç–µ—Å—Ç–æ–≤)

–†–µ–∑—É–ª—å—Ç–∞—Ç: –ö–û–î –ì–û–¢–û–í –ö PRODUCTION ‚úÖ
""")
print("=" * 70)

# –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ë–î
import os
if os.path.exists("tasks.db"):
    os.remove("tasks.db")
if os.path.exists("demo_safe.db"):
    os.remove("demo_safe.db")

print("\n‚úì –í—Ä–µ–º–µ–Ω–Ω—ã–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —É–¥–∞–ª–µ–Ω—ã")